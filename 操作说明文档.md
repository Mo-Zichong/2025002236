# 区块链抽签系统操作说明

## 1. 系统简介

本系统用于组织并执行公正、透明的随机抽签活动，通过区块链技术保障抽奖过程不可篡改、可验证。前端提供三维球体可视化界面，后台提供会话管理、报名、随机数承诺‑揭示、分轮次抽奖和结果导出等功能。

## 2. 全流程操作步骤

### 2.1 准备工作

1. **安装运行环境**：确保计算机已安装 Node.js (建议 v14 以上)。
2. **启动服务**：下载并解压源码，进入 `lottery_app` 目录，运行命令 `node server.js`。若默认端口 8090 已被占用，系统会自动尝试下一个端口并在终端提示实际端口号。
3. **访问系统**：在浏览器地址栏输入 `http://localhost:端口` 访问首页。建议使用现代浏览器（Chrome/Edge/Firefox）。

### 2.2 创建抽奖场次

1. 点击左侧“管理员面板”按钮打开管理界面。
2. 在“创建场次”中输入场次名称，例如“年会抽奖”。
3. 随机种子可通过两种方式提供：
   - **从天玄链生成**：点击“生成随机种子”按钮，系统会通过网易天玄链随机数服务获取一串不可预测的随机字符串，并自动填入种子输入框。如果无法连接天玄链或需要离线部署，可选择手动输入。
   - **手动输入**：输入一个 8～16 位甚至更长的随机字符串（数字或字母均可）。随机种子用于生成随机数，请务必妥善保存，**不要提前公开**。为增加安全性，建议使用大小写字母、数字混合的字符串，长度越长越安全（如 `Abc12345XYZ`）。
4. 点击“创建场次”按钮，系统将返回一个场次编号并在链上记录种子哈希。之后的操作均以该场次为单位进行。

### 2.3 报名参与者

选择所需操作的场次后，参与者可通过两种方式报名：

1. **单个添加**：在“参与者标识”输入框中输入参与者的标识（如工号、学号或姓名），点击“报名”按钮。系统会自动去除重复标识，不会出现重复报名。
2. **批量导入**：
   - 准备一份 CSV 文件或文本文件，每行一个参与者标识，第一行可以是表头。例如：
     ```csv
     id
     user01
     user02
     user03
     ...
     ```
     建议使用 Excel 编写名单后，选择“另存为”，文件类型选“CSV (逗号分隔)(*.csv)”或“文本文件 (*.txt)”保存。
   - 点击“批量导入参与者”后的文件选择框，选择准备好的 CSV 文件。
   - 点击“导入”按钮，系统将读取文件内容，过滤空行并自动去重，然后将新的参与者加入名单。导入完成后会提示成功导入的数量，并自动刷新三维球体。

> **注意**：单个报名与批量导入可以混合使用，系统会自动去除重复的参与者标识。如果一个标识已经通过单个报名加入，则再从 CSV 文件导入时不会重复添加，反之亦然。

### 2.4 准备抽奖

1. 确认所有参与者已报名且名单正确。切换场次或导入报名文件后系统会自动刷新参与者列表，可通过左侧三维球体查看卡片数量是否对应。
2. 关闭管理员面板回到主界面。此时抽奖按钮显示为“开始抽奖”。

### 2.5 揭示随机种子并分轮次抽奖

抽奖采用多轮次方式，按以下顺序依次抽出三等奖、二等奖、一等奖、特等奖（从低等奖项向高等奖项）。每一轮抽奖前都从剩余参与者中随机选出对应数量，保证中奖者不重复。

1. **揭示随机种子**：第一次点击“开始抽奖”时，系统会提示主持人在现场输入随机种子。此随机种子应提前通过天玄链或其他方式生成并保管好，输入后系统将验证其哈希值并在链上揭示，抽奖正式开始。若取消输入则不会开始抽奖。
2. **第一轮（三等奖）**：种子揭示后系统会自动抽出三等奖（默认 20 名或当前剩余参与者，如果参与者不足 20 则全部中三等奖），中奖卡片在球体中变为红色，同时在屏幕中央以浮层展示中奖者列表，按钮文本会自动变为“抽二等奖”。浮层将在下一次点击抽奖按钮时自动隐藏。
3. **第二轮（二等奖）**：再次点击抽奖按钮，将抽取二等奖（默认 5 名），中奖者同样以浮层展示并在球体中高亮，按钮文本变为“抽一等奖”。
4. **第三轮（一等奖）**：点击“抽一等奖”，抽取一等奖（默认 5 名），流程同上，按钮文本变为“抽特等奖”。
5. **第四轮（特等奖）**：点击“抽特等奖”，抽取特等奖（默认 1 名），完成后按钮显示“抽奖完成”并被禁用，提示所有奖项均已抽取。此时侧边栏每个奖项后面的计数会显示已抽数量/总数量，如“1/1”。抽奖完成后，侧边栏下方的“中奖名单”区域将按照 **三等奖→二等奖→一等奖→特等奖** 的顺序列出每一档次的中奖者，便于主持人或观众查看。

> **提示**：如果某一档奖项数量大于剩余参与者数量，系统会全部选中剩余参与者并自动结束抽奖。

### 2.6 导出抽奖结果

抽奖结束后或在任何阶段，可以点击左侧“导出抽奖结果”按钮，下载包含如下信息的 JSON 文件：

* `participants`：完整参与者列表；
* `winners`：按档次划分的中奖者对象，如 `{special:[...], first:[...], second:[...], third:[...]}`；
* `all`：按抽奖顺序排列的全部中奖者列表。

JSON 文件可用记事本或 Excel 打开。若需进一步编辑，可将其导入 Excel 并进行格式整理。

## 3. CSV 文件规范

* **文件扩展名**：支持 `.csv` 或 `.txt`，推荐使用 `.csv`。请确保文件采用 UTF‑8 编码。
* **每行一个标识**：每行包含一个参与者标识，建议使用唯一的英文或数字字符组合，例如工号或学号；
* **表头可选**：第一行可以是表头，如 `id` 或 `name`，导入时系统会自动判断并跳过；
* 示例：

  ```csv
  id
  user001
  user002
  user003
  ```

## 4. 随机种子建议

随机种子用于生成不可预测的随机数，可以通过天玄链服务自动获取，也可以手动生成。请遵循以下建议：

1. **优先使用天玄链随机数**：点击管理员面板的“生成随机种子”按钮即可从网易天玄链获取随机字符串，确保其公平、公正且无法预测；
2. **手动生成种子时**，应满足：
   - 长度至少 8～16 位；
   - 包含数字、大小写字母等多种字符；
   - 尽量随机，不要使用生日、手机号等易猜测的信息；
3. 在创建场次时系统仅保存随机种子的哈希值，原始种子请妥善保存。揭示随机种子时需手动输入该字符串，系统会验证其哈希值并用于抽奖基数；如果使用天玄链生成的种子，请复制后保留至抽奖开始。
4. 每个场次应使用不同的随机种子以防止被预测或重复使用。

## 5. 常见问题

**问：为什么导入 CSV 后有部分参与者未被添加？**  
答：系统会自动去除重复或空白的参与者标识，已存在的用户不会重复添加。

**问：如何重新抽奖？**  
答：如果同一场次已经抽奖并想重新抽取，需要重新创建一个新的抽奖场次，或在揭示随机种子时根据提示确认覆盖之前结果。由于系统无“重抽奖”按钮，重新抽奖操作将清空之前的中奖记录并从头开始。

**问：JSON 结果如何转换为 Excel？**  
答：可使用在线工具将 JSON 转换为 CSV 或将 JSON 粘贴到 Excel 中并使用“从文本/JSON 导入”功能解析。

## 6. 结束语

以上即为区块链抽签系统的完整操作流程及注意事项，如在使用过程中发现问题，请及时与开发者沟通反馈。祝您抽奖顺利！